<!DOCTYPE html>
<html lang="es">

<head>
    <!-- NOTA: Los enlaces a recursos locales (img/wlogo/Logo FashionStore.png, recursos/img/...) han sido mantenidos,
               pero no se mostrar√°n en un entorno que no pueda acceder a estos archivos. -->
    <link rel="stylesheet" href="img/wlogo/Logo FashionStore.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FashionStore M&Vüå∏üíú</title>
    <link rel="stylesheet" href="recursos/css/index.css">
</head>

<body>
    <div class="linea-superior"></div>

    <header>
        <img src="recursos/img/wlogo/Logo FashionStore.png" alt="Logo FashionStore" width="110" height="110"
            class="logo">
        <h1>Bienvenido a <span>FashionStore M&V</span></h1>
        <p>Descubre nuestro cat√°logo de ropa para <b><u>Mujer</u></b> y <b><u>Hombre</u></b>.</p>

        <!-- Bot√≥n del Carrito (NUEVO) -->
        <button id="cartButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-shopping-cart">
                <circle cx="8" cy="21" r="1" />
                <circle cx="19" cy="21" r="1" />
                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.72a2 2 0 0 0 2-1.58L23.95 5.5h-18.1" />
            </svg>
            <span id="cartCount">0</span>
        </button>
    </header>

    <div class="contenedor">
        <a href="#mujer" class="rectangulo">Secci√≥n Mujer</a>
        <a href="#hombre" class="rectangulo">Secci√≥n hombre</a>
        <a href="#gorras" class="rectangulo">Secci√≥n Gorras</a>
    </div>

    <!--barra de busqueda-->
    <div class="buscador">
        <input type="text" id="searchInput" placeholder="Buscar producto... üîç">
    </div>

    <!-- NOTA IMPORTANTE: Para que el carrito funcione, hemos a√±adido los atributos 'data-name' y 'data-price' a los menu-item. -->

    <!-- Secci√≥n Mujer -->
    <div id="mujer" class="categoria">
        <h2 style="text-align: center; background-color: #ffbce7;">Mujer:</h2>
        <section class="menu">

            <div class="menu-item" data-id="1" data-name="Enterizo Corto De Formula 1 Rojo" data-price="18000">
                <a href="productos/enterizos/mujer/EnterizoCortoDeFormula1Rojo.html">
                    <div class="img-container">
                        <img src="recursos/img/enterizos/mujer/EnterizoLargoDeFormula1Rojo.jpeg"
                            alt="Enterizo Largo De Formula 1 Rojo">
                        <div class="overlay">Ver Detalles</div>
                    </div>
                    <h3>Enterizo Corto De Formula 1 Rojo</h3>
                    <h3>$18.000</h3>
                </a>
                <button class="add-to-cart-btn" data-id="1">A√±adir al Carrito</button>
            </div>

            <div class="menu-item" data-id="2" data-name="Enterizo Corto De F√≥rmula 1 Negro" data-price="19500"
                style="background: #ff95a2;">
                <a href="productos/enterizos/mujer/EnterizoCortoDeFormula1Negro.html">
                    <div class="img-container">
                        <img src="recursos/img/enterizos/mujer/EnterizoCortoDeFormula1Negro.jpeg"
                            alt="Enterizo Corto De F√≥rmula 1 Negro">
                        <div class="overlay">Ver Detalles</div>
                    </div>
                    <h3>Enterizo Corto De F√≥rmula 1 Negro</h3>
                    <h3>$19.500</h3>
                </a>
                <button class="add-to-cart-btn" data-id="2">A√±adir al Carrito</button>
            </div>

            <div class="menu-item" data-id="3" data-name="Conjunto Deportivo Original" data-price="32000">
                <a href="productos/conjuntos/mujer/ConjuntoDeportivoOriginal.html">
                    <div class="img-container">
                        <img src="recursos/img/conjuntos/mujer/ConjuntoDeportivoOriginal.jpeg"
                            alt="Conjunto Deportivo Original">
                        <div class="overlay">Ver Detalles</div>
                    </div>
                    <h3>Conjunto Deportivo Original</h3>
                    <h3>$32.000</h3>
                </a>
                <button class="add-to-cart-btn" data-id="3">A√±adir al Carrito</button>
            </div>

        </section>
    </div>

    <!-- Seccion Hombre-->
    <div id="hombre" class="categoria">
        <h2 style="text-align: center; background-color: #a2acff;">Hombre:</h2>
        <section class="menu">
            <!-- Vestimentas-->
            <div class="menu-item" data-id="4" data-name="Conjunto De Ni√±o" data-price="15000">
                <a href="productos/conjuntos/hombre/ConjuntoDeNi√±o.html">
                    <div class="img-container">
                        <img src="recursos/img/conjuntos/hombre/ConjuntoDeNi√±o.jpeg" alt="Conjunto De Ni√±o">
                        <div class="overlay">Ver Detalles</div>
                    </div>
                    <h3>Conjunto De Ni√±o</h3>
                    <h3>$15.000</h3>
                </a>
                <button class="add-to-cart-btn" data-id="4">A√±adir al Carrito</button>
            </div>

        </section>
    </div>

    <!-- Seccion de gorras-->
    <div id="gorras" class="categoria">
        <h2 style="text-align: center; background-color: #edfff3;">Gorras:</h2>

        <section class="menu">
            <!-- Gorras -->
            <div class="menu-item" data-id="5" data-name="Gorra Roja New York" data-price="8500">
                <a href="productos/conjuntos/hombre/ConjuntoDeNi√±o.html">
                    <div class="img-container">
                        <img src="recursos/img/gorras/GorraRojaNewYork.webp" alt="Gorra Roja New York">
                        <div class="overlay">Ver Detalles</div>
                    </div>
                    <h3>Gorra Roja New York</h3>
                    <h3>$8.500</h3>
                </a>
                <button class="add-to-cart-btn" data-id="5">A√±adir al Carrito</button>
            </div>

        </section>
    </div>

    <section class="creditos">
        <h3>Para Obtener M√°s Informaci√≥n Ingresa Al Siguiente Canal De WhatsApp:</h3>
        <div la class="link">
            <a href="https://whatsapp.com/channel/0029VbBSoksISTkJGZYDiK1l" class="rectangulo">Sigue el canal de
                FashionStore M&V üíú</a>
        </div>
    </section>

    <!-- Panel de Carrito (NUEVO) -->
    <div id="cartBackdrop"></div>
    <div id="cartPanel">
        <div class="cart-header">
            <h3>Tu Pedido</h3>
            <button onclick="closeCartPanel()" style="background:none; border:none; color:#333; cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-x">
                    <path d="M18 6 6 18" />
                    <path d="m6 6 12 12" />
                </svg>
            </button>
        </div>

        <div id="cartItemsContainer">
            <p id="emptyCartMessage" style="text-align: center; color: #999; margin-top: 20px;">El carrito est√° vac√≠o.
            </p>
        </div>

        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; font-size:1.5rem; font-weight:700; color:#ff4eb8;">
                <span>Total:</span>
                <span id="cartTotal">$0</span>
            </div>

            <button id="checkoutButton" onclick="processOrder()">
                Enviar Pedido por WhatsApp
            </button>

            <p style="font-size: 0.8rem; color: #9d63ff; margin-top: 10px;">Se generar√° un C√≥digo √önico para tu
                confirmaci√≥n.</p>
        </div>
    </div>


    <script>
        // --- CONFIGURACI√ìN ---
        const WHATSAPP_NUMBER = "56954356331"; // Reemplaza con tu n√∫mero de WhatsApp real (ej: 56912345678)
        const CART_STORAGE_KEY = 'fashionStoreCart';

        // --- REFERENCIAS DEL DOM ---
        const cartButton = document.getElementById('cartButton');
        const cartPanel = document.getElementById('cartPanel');
        const cartBackdrop = document.getElementById('cartBackdrop');
        const cartCountSpan = document.getElementById('cartCount');
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const cartTotalSpan = document.getElementById('cartTotal');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const checkoutButton = document.getElementById('checkoutButton');
        const searchInput = document.getElementById('searchInput');
        const productItems = document.querySelectorAll('.menu-item');

        // --- L√ìGICA DE ALMACENAMIENTO Y LECTURA ---

        /** Lee el carrito de localStorage */
        function getCart() {
            const cartString = localStorage.getItem(CART_STORAGE_KEY);
            return cartString ? JSON.parse(cartString) : [];
        }

        /** Guarda el carrito en localStorage */
        function saveCart(cart) {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            updateCartUI(cart);
        }

        /** Formatea un n√∫mero como moneda local */
        function formatCurrency(number) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(number);
        }

        // --- FUNCIONES DE CARRITO ---

        /** A√±ade un producto al carrito */
        function addItemToCart(id, name, price) {
            let cart = getCart();
            const existingItemIndex = cart.findIndex(item => item.id === id);

            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += 1;
            } else {
                cart.push({ id, name, price: parseFloat(price), quantity: 1 });
            }
            saveCart(cart);
            openCartPanel();
        }

        /** Cambia la cantidad de un art√≠culo en el carrito */
        window.changeQuantity = function (id, delta) {
            let cart = getCart();
            const itemIndex = cart.findIndex(item => item.id === id);

            if (itemIndex > -1) {
                cart[itemIndex].quantity += delta;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1); // Eliminar si la cantidad es cero o menos
                }
                saveCart(cart);
            }
        }

        /** Elimina un art√≠culo del carrito */
        window.removeItem = function (id) {
            let cart = getCart();
            cart = cart.filter(item => item.id !== id);
            saveCart(cart);
        }

        /** Actualiza la interfaz del carrito */
        function updateCartUI(cart) {
            cartItemsContainer.innerHTML = '';

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            cartCountSpan.textContent = totalItems;
            cartTotalSpan.textContent = formatCurrency(totalAmount);

            emptyCartMessage.style.display = cart.length === 0 ? 'block' : 'none';
            checkoutButton.disabled = cart.length === 0;

            if (cart.length > 0) {
                cart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cart-item';
                    itemElement.innerHTML = `
                        <div style="flex: 1; min-width: 0; padding-right: 10px;">
                            <p style="font-weight: 600; margin: 0; color: #7b4eff;">${item.name}</p>
                            <p style="font-size: 0.9rem; color: #555; margin: 0;">${formatCurrency(item.price)} c/u</p>
                        </div>
                        <div class="cart-item-controls">
                            <button onclick="changeQuantity('${item.id}', -1)">-</button>
                            <span style="font-weight: bold; min-width: 20px; text-align: center;">${item.quantity}</span>
                            <button onclick="changeQuantity('${item.id}', 1)">+</button>
                            <button onclick="removeItem('${item.id}')" style="background: #ff4eb8;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });
            }
        }

        // --- L√ìGICA DE CHECKOUT Y WHATSAPP ---

        /** Genera un C√≥digo √önico de Pedido */
        function generateUniqueCode() {
            // C√≥digo simple: FS- + 6 caracteres alfanum√©ricos (puedes cambiar el prefijo)
            return 'FS-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        /** Procesa el pedido, genera el c√≥digo, lo guarda en Firestore y env√≠a a WhatsApp */
        window.processOrder = async function () {
            const cart = getCart();
            if (cart.length === 0) return;

            // --- IMPORTANTE: Abrir una ventana en el mismo gesto del usuario ANTES de hacer awaits
            // Esto evita que los navegadores (especialmente iOS) bloqueen la apertura por ser "no iniciada por el usuario".
            let userWindow = null;
            try {
                userWindow = window.open('', '_blank'); // ventana temporal; la redirigiremos luego
            } catch (e) {
                userWindow = null;
            }

            const uniqueCode = generateUniqueCode();
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            // Construir la lista de productos para el mensaje
            const productList = cart.map(item => {
                const itemPrice = formatCurrency(item.price);
                const itemTotal = formatCurrency(item.price * item.quantity);
                return `- ${item.name} (c/u: ${itemPrice}) x${item.quantity} (Subtotal: ${itemTotal})`;
            }).join('\n');

            // Crear objeto de datos para Firestore
            const pedidoData = {
                codigo: uniqueCode,
                fecha: null, // ser√° reemplazado por serverTimestamp al guardar
                total: total,
                productos: cart.map(item => ({
                    nombre: item.name,
                    cantidad: item.quantity,
                    precio: item.price,
                    subtotal: item.price * item.quantity
                }))
            };

            try {
                // üî• Guardar pedido en Firestore usando serverTimestamp()
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js");
                const { getFirestore, collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js");

                const firebaseConfig = {
                    apiKey: "AIzaSyCHYo8LYSyOqgr6tBgo9RXODH0KRwZeowQ",
                    authDomain: "live-de-eso.firebaseapp.com",
                    projectId: "live-de-eso",
                    storageBucket: "live-de-eso.firebasestorage.app",
                    messagingSenderId: "250545251960",
                    appId: "1:250545251960:web:94ad354f2650d46d32af8d"
                };

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);

                // Asignamos serverTimestamp al campo 'fecha'
                const docRef = await addDoc(collection(db, "pedidos"), {
                    ...pedidoData,
                    fecha: serverTimestamp()
                });

                console.log("‚úÖ Pedido guardado en Firestore con c√≥digo:", uniqueCode, "id:", docRef.id);
            } catch (error) {
                console.error("‚ùå Error al guardar el pedido:", error);
                alert("Hubo un error al registrar tu pedido en el sistema, pero puedes enviarlo igual por WhatsApp.");
            }

            // Mensaje para WhatsApp (mantiene tu formato original)
            const message = `
*üõçÔ∏è PEDIDO FASHIONSTORE M&V üõçÔ∏è*
*C√ìDIGO √öNICO DE PEDIDO:* ${uniqueCode}

¬°Hola! Me gustar√≠a realizar el siguiente pedido:

---
*Detalle del Pedido*
${productList}
---
*Costo Total:* ${formatCurrency(total)}

*IMPORTANTE:* Usa este c√≥digo para confirmar tu pedido con el personal.

*DATOS DE CONTACTO:*
(Por favor, ingresa tu nombre y direcci√≥n de env√≠o aqu√≠)
`;
            const encodedMessage = encodeURIComponent(message.trim());
            const whatsappWebUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
            const whatsappAppUrl = `whatsapp://send?phone=${WHATSAPP_NUMBER}&text=${encodedMessage}`;

            // Intentamos abrir el esquema de la app primero (whatsapp://). Si falla, abrimos el enlace web https://wa.me/
            try {
                if (userWindow) {
                    // Redirige la ventana abierta previamente. Primero intenta el esquema de la app.
                    userWindow.location.href = whatsappAppUrl;

                    // Si tras 700ms la app no abri√≥ (ej. no est√° instalada), redirigimos al fallback web.
                    setTimeout(() => {
                        try {
                            // muchas veces no podemos leer estado, as√≠ que forzamos fallback:
                            if (!userWindow.closed) {
                                userWindow.location.href = whatsappWebUrl;
                            }
                        } catch (e) {
                            // si hay error, intentar abrir en la ventana principal
                            window.location.href = whatsappWebUrl;
                        }
                    }, 700);
                } else {
                    // Si popup fue bloqueado (= null), intentamos cambiar la ubicaci√≥n en la misma ventana.
                    // Primero app-scheme, luego fallback a web.
                    window.location.href = whatsappAppUrl;
                    setTimeout(() => {
                        window.location.href = whatsappWebUrl;
                    }, 700);
                }
            } catch (err) {
                // En caso de cualquier error, ir al fallback web
                try {
                    if (userWindow && !userWindow.closed) userWindow.location.href = whatsappWebUrl;
                    else window.location.href = whatsappWebUrl;
                } catch (e) {
                    window.location.href = whatsappWebUrl;
                }
            }

            // Opcional: limpiar carrito despu√©s de enviar (se mantiene)
            localStorage.removeItem(CART_STORAGE_KEY);
            updateCartUI([]);
            closeCartPanel();
        };


        // --- L√ìGICA DE INTERFAZ (UI) ---

        function openCartPanel() {
            cartPanel.classList.add('open');
            cartBackdrop.style.display = 'block';
        }

        window.closeCartPanel = function () {
            cartPanel.classList.remove('open');
            cartBackdrop.style.display = 'none';
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Cargar carrito inicial
            updateCartUI(getCart());

            // 2. Listener para abrir carrito
            cartButton.addEventListener('click', openCartPanel);
            cartBackdrop.addEventListener('click', closeCartPanel);

            // 3. Listener para botones de a√±adir al carrito
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const productElement = e.target.closest('.menu-item');
                    const name = productElement.getAttribute('data-name');
                    const price = productElement.getAttribute('data-price');

                    addItemToCart(id, name, price);
                });
            });

            // 4. L√≥gica de b√∫squeda (Mantenida de tu c√≥digo original)
            searchInput.addEventListener('input', () => {
                const filtro = searchInput.value.toLowerCase();
                productItems.forEach(producto => {
                    const nombre = producto.querySelector('h3').textContent.toLowerCase();
                    producto.style.display = nombre.includes(filtro) ? 'block' : 'none';
                });
            });
        });
    </script>

</body>

</html>
